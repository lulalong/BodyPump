<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BodyPump">
<link rel="apple-touch-icon" href="icon.png">
<title>BodyPump</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Metal+Mania&family=Barlow:wght@400;500;600;700;900&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  @font-face {
    font-family: 'Metal Mania';
    src: url('MetalMania-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }
</style>
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --border: #1e1e1e;
    --accent: #c0392b;
    --accent2: #8e1c14;
    --pink: #c27ba0;
    --pink-dim: #7a3d5f;
    --text: #f0f0f0;
    --text-dim: #888;
    --banner: #1a0a08;
    --banner-border: #5B0F00;
    --active-glow: rgba(192, 57, 43, 0.15);
    --active-border: #c0392b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
    touch-action: manipulation;
  }

  /* ‚îÄ‚îÄ WAKE LOCK INDICATOR ‚îÄ‚îÄ */
  #wake-indicator {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: #333;
    flex-shrink: 0;
    transition: background 0.3s;
  }
  #wake-indicator.active { background: #2ecc71; box-shadow: 0 0 6px #2ecc71; }

  /* ‚îÄ‚îÄ BIG TAP ZONE ‚îÄ‚îÄ */
  #tap-zone {
    display: none;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  #header {
    display: flex;
    align-items: center;
    padding: 10px 18px;
    padding-top: max(10px, env(safe-area-inset-top));
    background: var(--surface);
    border-bottom: 2px solid var(--accent2);
    flex-shrink: 0;
    gap: 8px;
    position: relative;
    z-index: 20;
  }

  #track-info {
    display: flex;
    flex-direction: column;
    min-width: 0;
    flex: 1;
    overflow: hidden;
  }

  #controls-centre {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #track-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 2px;
    color: var(--text);
    line-height: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #song-info {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Dots moved to sub-bar below header */
  #progress-dots {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-shrink: 0;
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border);
    border: 1px solid #333;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    background-clip: content-box;
    flex-shrink: 0;
  }
  .dot:hover::after {
    content: attr(data-label);
    position: absolute;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: var(--text);
    font-size: 10px;
    white-space: nowrap;
    padding: 3px 6px;
    border-radius: 3px;
    font-family: 'Barlow Condensed', sans-serif;
    letter-spacing: 0.5px;
    pointer-events: none;
  }
  .dot.done { background: var(--accent2); border-color: var(--accent2); }
  .dot.active { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 6px var(--accent); width: 12px; height: 12px; }

  #clock {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--accent);
    letter-spacing: 2px;
    min-width: 70px;
    text-align: right;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
  #controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-shrink: 0;
  }

  .btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    min-height: 40px;
    min-width: 40px;
    white-space: nowrap;
  }
  .btn-primary {
    background: var(--accent);
    color: white;
    padding: 10px 40px;
    font-size: 20px;
    min-height: 56px;
  }
  .btn-primary:hover { background: #e74c3c; }
  .btn-secondary {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid #333;
    font-size: 18px;
    min-height: 48px;
    min-width: 48px;
  }
  .btn-secondary:hover { border-color: var(--text-dim); color: var(--text); }
  .btn-ghost {
    background: transparent;
    color: var(--text-dim);
    font-size: 14px;
    padding: 4px 8px;
  }
  .btn-ghost:hover { color: var(--text); }

  /* ‚îÄ‚îÄ SUB-BAR (dots + meta + clock) ‚îÄ‚îÄ */
  #sub-bar {
    display: flex;
    align-items: center;
    padding: 8px 18px;
    background: #0a0a0a;
    border-bottom: 2px solid var(--accent2);
    flex-shrink: 0;
  }

  #sub-bar-meta {
    display: flex;
    gap: 28px;
    align-items: center;
    justify-content: center;
    flex: 1;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  #sub-bar-meta .meta-item { color: var(--text-dim); white-space: nowrap; }
  #sub-bar-meta .meta-item span { color: var(--text); font-weight: 600; }

  /* ‚îÄ‚îÄ MAIN SCROLL AREA ‚îÄ‚îÄ */
  #scroll-container {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }

  #scroll-track {
    padding: 0 0 60vh 0;
  }

  /* ‚îÄ‚îÄ ROWS ‚îÄ‚îÄ */
  .row {
    display: grid;
    grid-template-columns: 220px 1fr 90px;
    border-bottom: 1px solid #111111;
    transition: all 0.4s ease;
    opacity: 0.35;
    position: relative;
    user-select: none;
    -webkit-user-select: none;
  }

  .row.banner {
    grid-template-columns: 1fr;
    background: var(--banner);
    border-left: 3px solid var(--banner-border);
    opacity: 0.45;
  }

  .row.active {
    opacity: 1;
    background: #1a2a1a;
    border-bottom-color: #3a7a3a;
    border-left: 3px solid #4caf50;
  }

  .row.active.banner {
    background: #1a2a1a;
    border-left-color: #4caf50;
    border-bottom-color: #3a7a3a;
    opacity: 1;
  }

  .row.next {
    opacity: 0.7;
  }

  .cell {
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .cell-timing {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--text-dim);
    letter-spacing: 1px;
    line-height: 1.1;
    word-break: break-word;
  }

  .row.active .cell-timing {
    font-size: 44px;
    color: #ffffff;
  }

  .cell-move {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: #ffffff;
    letter-spacing: 1px;
    line-height: 1.2;
  }

  .row.active .cell-move {
    font-size: 44px;
    color: #ffffff;
  }

  .cell-cue {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px;
    font-weight: 400;
    color: var(--text-dim);
    margin-top: 4px;
    font-style: italic;
    letter-spacing: 0.5px;
  }

  .cell-reps {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    color: var(--text-dim);
    text-align: center;
    letter-spacing: 1px;
  }

  .row.active .cell-reps {
    font-size: 64px;
    color: #4caf50;
  }

  .cell-banner {
    padding: 16px 24px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #888;
  }

  .row.active .cell-banner {
    font-size: 26px;
    color: #ffffff;
  }

  /* ‚îÄ‚îÄ HEADER ROW ‚îÄ‚îÄ */
  .row-header {
    display: grid;
    grid-template-columns: 220px 1fr 90px;
    border-bottom: 2px solid var(--accent2);
    opacity: 1 !important;
    background: #0f0f0f;
  }

  .cell-header {
    padding: 12px 20px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  .cell-header:last-child { text-align: center; }

  .meta-item { color: var(--text-dim); }
  .meta-item span { color: var(--text); font-weight: 600; }

  /* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
  #song-progress-bar {
    height: 3px;
    background: var(--border);
    flex-shrink: 0;
  }
  #song-progress-fill {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 1s linear;
  }

  /* ‚îÄ‚îÄ TRACK SELECT MODAL ‚îÄ‚îÄ */
  .calib-badge {
    position: absolute;
    top: 10px;
    right: 12px;
    font-size: 16px;
    line-height: 1;
    opacity: 0.9;
  }

  /* ‚îÄ‚îÄ ROUTINE MENU ‚îÄ‚îÄ */
  #routine-menu {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    z-index: 110;
    backdrop-filter: blur(4px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: max(20px, env(safe-area-inset-top)) 0 max(20px, env(safe-area-inset-bottom));
  }
  #routine-menu.hidden { display: none; }
  #routine-menu-inner {
    width: min(700px, 95vw);
    padding: 20px 0;
  }
  #routine-menu-inner h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    color: var(--accent);
    margin: 0 0 4px;
    text-align: center;
  }
  #routine-subtitle {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 3px;
    color: var(--text-dim);
    text-align: center;
    margin-bottom: 24px;
  }
  #routine-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 0 12px;
  }
  .routine-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .routine-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--accent);
    transform: scaleY(0);
    transition: transform 0.2s;
  }
  .routine-card:hover { border-color: var(--accent2); background: #161616; }
  .routine-card:hover::before { transform: scaleY(1); }
  .routine-card-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    color: var(--text);
    line-height: 1;
    margin-bottom: 8px;
  }
  .routine-card-meta {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    color: var(--text-dim);
  }

  #track-select {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: max(20px, env(safe-area-inset-top)) 0 max(20px, env(safe-area-inset-bottom));
  }

  #track-select.hidden { display: none; }

  #track-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    max-width: 600px;
    width: 90%;
    padding: 20px;
  }

  #track-select h2 {
    margin: 0;
    text-align: center;
    flex: 1;
  }
  #track-select-header {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 3px;
    color: var(--accent);
    margin-bottom: 4px;
    text-align: center;
    grid-column: 1/-1;
  }

  #routine-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #cccccc;
    text-align: center;
    grid-column: 1/-1;
    margin-bottom: 28px;
    text-shadow:
      3px 3px 0px #444444,
      6px 6px 0px rgba(0, 0, 0, 0.5);
    line-height: 1.1;
  }

  .track-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .track-card-text {
    flex: 1;
  }
  .track-card-icon {
    width: 64px;
    height: 64px;
    object-fit: contain;
    flex-shrink: 0;
    margin-left: 16px;
    opacity: 0.9;
  }

  .track-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--accent);
    transform: scaleY(0);
    transition: transform 0.2s;
  }

  .track-card:hover {
    border-color: var(--accent2);
    background: #161616;
  }
  .track-card:hover::before { transform: scaleY(1); }

  .track-card-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .track-card-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 1px;
    color: var(--text);
    line-height: 1;
  }

  .track-card-song {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
    font-family: 'Barlow Condensed', sans-serif;
    letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ COUNTDOWN OVERLAY ‚îÄ‚îÄ */
  #countdown-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(2px);
  }
  #countdown-overlay.hidden { display: none; }

  /* ‚îÄ‚îÄ BREAK HOLDING SCREEN ‚îÄ‚îÄ */
  #break-screen {
    position: fixed;
    inset: 0;
    background: #0a0a0a;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 40;
    flex-direction: column;
  }
  #break-screen.hidden { display: none; }
  #break-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  #break-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 4px;
    color: var(--text-dim);
  }
  #break-next-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 3px;
    color: var(--text-dim);
    margin-top: 16px;
  }
  #break-next-track {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 72px;
    color: var(--text);
    line-height: 1;
    letter-spacing: 2px;
  }
  #break-timer {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 120px;
    color: var(--accent);
    line-height: 1;
    margin-top: 8px;
  }
  #break-bar-wrap {
    width: 300px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  #break-bar {
    height: 100%;
    background: var(--accent);
    width: 100%;
    transition: width 1s linear;
  }
  #btn-autoplay.active {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
  }

  #countdown-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 160px;
    color: var(--accent);
    line-height: 1;
    animation: pulse-num 1s ease-in-out infinite;
  }

  #countdown-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-top: 8px;
  }

  @keyframes pulse-num {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.06); }
  }

  /* ‚îÄ‚îÄ NEXT MOVE COUNTDOWN ‚îÄ‚îÄ */
  #next-move-countdown {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: #1a1400;
    border: 3px solid #f0a500;
    border-radius: 8px;
    padding: 18px 42px;
    text-align: center;
    z-index: 15;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #next-move-countdown.visible { opacity: 1; }

  #nmc-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #f0a500;
    margin-bottom: 3px;
  }
  #nmc-move {
    font-family: 'Barlow', sans-serif;
    font-size: 30px;
    font-weight: 700;
    color: #ffffff;
  }
  #nmc-secs {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 2px;
    color: #f0a500;
    margin-top: 3px;
  }

  /* Long-press jump indicator */
  .row.jump-ready {
    background: #0a1a0a !important;
    border-left-color: #4caf50 !important;
    transition: background 0.4s ease;
  }
  body.calibrating #tap-zone { pointer-events: none; }

  #calib-bar {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    background: #1a1000;
    border-bottom: 2px solid #c87000;
    flex-shrink: 0;
    z-index: 15;
    position: relative;
  }
  #calib-bar.visible { display: flex; }

  #calib-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: #c87000;
    flex: 1;
  }
  #calib-label strong { color: #ffaa00; }

  #calib-next-btn {
    background: #c87000;
    color: #000;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 2px;
    padding: 10px 28px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    min-height: 52px;
    min-width: 160px;
    transition: background 0.1s;
  }
  #calib-next-btn:active { background: #ffaa00; transform: scale(0.97); }

  #calib-save-btn {
    background: #2ecc71;
    color: #000;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 10px 22px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    min-height: 52px;
    display: none;
  }
  #calib-save-btn.visible { display: block; }

  /* Calibrated rows get a small timestamp badge */
  .row .calib-stamp {
    display: none;
    position: absolute;
    top: 4px; right: 6px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    color: #c87000;
    letter-spacing: 1px;
  }
  body.calibrating .row .calib-stamp { display: block; }

  /* Calibration result modal */
  #calib-result {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    z-index: 200;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 30px 24px;
    overflow-y: auto;
    display: none;
  }
  #calib-result.visible { display: flex; }
  #calib-result h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 30px;
    letter-spacing: 3px;
    color: #ffaa00;
    margin-bottom: 8px;
  }
  #calib-result p {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    color: var(--text-dim);
    margin-bottom: 20px;
    text-align: center;
    letter-spacing: 0.5px;
    line-height: 1.5;
  }
  #calib-result pre {
    background: #111;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 16px;
    font-size: 12px;
    color: #aaffaa;
    width: 100%;
    max-width: 700px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
    font-family: 'Courier New', monospace;
    line-height: 1.6;
    margin-bottom: 16px;
  }
  #calib-result .calib-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 8px;
  }

  /* ‚îÄ‚îÄ LANDSCAPE / LARGE SCREEN TWEAKS ‚îÄ‚îÄ */
  @media (orientation: landscape) and (min-width: 900px) {
    .row { grid-template-columns: 240px 1fr 100px; }
    .row-header { grid-template-columns: 240px 1fr 100px; }
    .cell-timing { font-size: 34px; }
    .row.active .cell-timing { font-size: 42px; }
    .cell-move { font-size: 28px; }
    .row.active .cell-move { font-size: 40px; }
    .cell-reps { font-size: 46px; }
    .row.active .cell-reps { font-size: 70px; }
    .cell-banner { font-size: 22px; }
    .row.active .cell-banner { font-size: 28px; }
  }

  /* ‚îÄ‚îÄ PORTRAIT / SMALL SCREEN ‚îÄ‚îÄ */
  @media (max-width: 600px) {
    .row { grid-template-columns: 140px 1fr 70px; }
    .row-header { grid-template-columns: 140px 1fr 70px; }
    #track-name { font-size: 22px; }
    #song-info { font-size: 11px; }
    #progress-dots { display: none; }
    #clock { font-size: 24px; }
  }

</style>
</head>
<body>
<!-- Routine data files: add a new script tag below for each routine -->
<script src="routines/nu-metal.js"></script>
<script src="routines/bodypump-10.js"></script>

<!-- Routine Menu -->
<div id="routine-menu">
  <div id="routine-menu-inner">
    <h2>BodyPump</h2>
    <div id="routine-subtitle">Choose a routine</div>
    <div id="routine-grid"></div>
  </div>
</div>

<!-- Track Select Modal -->
<div id="track-select" class="hidden">
  <div id="track-grid">
    <h2>BodyPump</h2>
  </div>
</div>

<!-- Countdown Overlay -->
<div id="countdown-overlay" class="hidden">
  <div id="countdown-num">10</div>
  <div id="countdown-label">Starting track‚Ä¶</div>
</div>

<!-- Break Holding Screen -->
<div id="break-screen" class="hidden">
  <div id="break-content">
    <div id="break-label">CHANGE WEIGHT ¬∑ DRINK WATER</div>
    <div id="break-next-label">GET READY FOR</div>
    <div id="break-next-track"></div>
    <div id="break-timer"></div>
    <div id="break-bar-wrap"><div id="break-bar"></div></div>
  </div>
</div>

<!-- Header -->
<div id="header">
  <div id="track-info">
    <div id="track-name">‚Äî</div>
    <div id="song-info">‚Äî</div>
  </div>
  <div id="controls-centre">
    <button class="btn btn-primary" id="btn-play" onclick="togglePlay()">PLAY</button>
  </div>
  <div id="controls">
    <button class="btn btn-secondary" onclick="showTrackSelect()">‚åÇ</button>
    <button class="btn btn-secondary" id="btn-prev-track" onclick="prevTrack()">‚üµ</button>
    <button class="btn btn-secondary" id="btn-restart" onclick="restartTrack()">‚Ü∫</button>
    <button class="btn btn-secondary" id="btn-calib" onclick="startCalibration()">üéØ</button>
    <button class="btn btn-secondary" id="btn-next-track" onclick="nextTrack()">‚ü∂</button>
    <button class="btn btn-secondary" id="btn-autoplay" onclick="toggleAutoplay()" title="Autoplay">‚ñ∂‚ñ∂</button>
  </div>
</div>

<!-- Sub-bar: dots + clock -->
<div id="sub-bar">
  <div id="progress-dots"></div>
  <div id="sub-bar-meta" id="track-meta-strip"></div>
  <div id="clock">0:00</div>
</div>

<!-- Song progress bar -->
<div id="song-progress-bar"><div id="song-progress-fill"></div></div>

<!-- Calibration bar (shown in calibration mode) -->
<div id="calib-bar">
  <div id="calib-label">üéØ Calibration ‚Äî <strong id="calib-move-name">‚Äî</strong></div>
  <button id="calib-save-btn" onclick="finishCalibration()">Save timestamps</button>
  <button id="calib-next-btn" onclick="calibTap()">TAP ‚ñ∂ NEXT MOVE</button>
</div>

<!-- Calibration result modal -->
<div id="calib-result">
  <h2>Calibration Complete</h2>
  <p>Copy these durations into the TRACKS data for <strong id="calib-result-track"></strong>.<br>Replace the existing <code>duration</code> values for each move.</p>
  <pre id="calib-result-code"></pre>
  <div class="calib-actions">
    <button class="btn btn-secondary" onclick="document.getElementById('calib-result').classList.remove('visible')">Close</button>
    <button class="btn btn-primary" onclick="copyCalibResult()">Copy to clipboard</button>
  </div>
</div>

<!-- Scroll area -->
<div id="scroll-container" style="position:relative;">
  <div id="tap-zone" onclick="handleTapZone()"></div>
  <div id="scroll-track">
    <!-- Header row -->
    <div class="row-header">
      <div class="cell-header">Timing</div>
      <div class="cell-header">Move</div>
      <div class="cell-header">Reps</div>
    </div>
    <!-- Rows injected here -->
    <div id="rows-container"></div>
  </div>
</div>

<!-- Next move countdown -->
<div id="next-move-countdown">
  <div id="nmc-label">Next Move</div>
  <div id="nmc-move">‚Äî</div>
  <div id="nmc-secs">in 5 seconds</div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TRACK DATA
// Each move: { type: 'data'|'banner', timing, move, reps, cue, highlight, duration (seconds) }
// duration = how long this move takes in the actual song
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ ROUTINE DATA (loaded dynamically) ‚îÄ‚îÄ
let ROUTINE_NAME = '';
let TRACKS = [];
let TRACK_ICONS = {};
let TRACK_ICON_MAP = {};
let BREAK_AFTER = {};



function updateNextMoveCountdown() {
  const track = TRACKS[currentTrackIdx];
  const el = document.getElementById('next-move-countdown');

  // Find the next move timestamp
  const nextMoveIdx = currentMoveIdx + 1;
  if (nextMoveIdx >= moveTimestamps.length) {
    hideNextMoveCountdown();
    return;
  }

  const nextStartsAt = moveTimestamps[nextMoveIdx];
  const secsUntil = nextStartsAt - elapsed;

  if (secsUntil > 0 && secsUntil <= 5) {
    const nextMove = track.moves[nextMoveIdx];
    // Skip banners ‚Äî look for next actual data move name
    let label = nextMove.move;

    document.getElementById('nmc-move').textContent = label;
    document.getElementById('nmc-secs').textContent =
      secsUntil === 1 ? 'in 1 second' : `in ${secsUntil} seconds`;
    el.classList.add('visible');
  } else {
    hideNextMoveCountdown();
  }
}

function hideNextMoveCountdown() {
  document.getElementById('next-move-countdown').classList.remove('visible');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PERSISTENCE ‚Äî save/load calibrated durations
// via localStorage so they survive page refresh
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STORAGE_KEY = 'nmbp_calibrations';

function saveCalibrations() {
  try {
    const data = {};
    TRACKS.forEach(t => {
      if (t.introOffset !== undefined) {
        data[t.id] = {
          totalDuration: t.totalDuration,
          introOffset: t.introOffset,
          durations: t.moves.map(m => m.duration)
        };
      }
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch(e) {}
}

function loadCalibrations() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    TRACKS.forEach(t => {
      if (data[t.id]) {
        t.totalDuration = data[t.id].totalDuration;
        if (data[t.id].introOffset !== undefined) {
          t.introOffset = data[t.id].introOffset;
        }
        data[t.id].durations.forEach((d, i) => {
          if (t.moves[i]) t.moves[i].duration = d;
        });
      }
    });
  } catch(e) { /* corrupt storage ‚Äî ignore */ }
}
let currentTrackIdx = 0;
let currentMoveIdx  = -1;
let elapsed = 0;       // seconds elapsed in track
let playing = false;
let timer = null;
let moveTimestamps = []; // cumulative start time for each move

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT TRACK SELECT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTrackSelect() {
  const grid = document.getElementById('track-grid');
  grid.innerHTML = '<div id="track-select-header"><button class="btn btn-secondary" onclick="showRoutineMenu()" style="font-size:12px;letter-spacing:2px;">‚Üê ROUTINES</button></div><div id="routine-name">' + ROUTINE_NAME + '</div>';

  TRACKS.forEach((t, i) => {
    const isCalibrated = t.introOffset !== undefined;
    const card = document.createElement('div');
    card.className = 'track-card';
    const iconKey = TRACK_ICON_MAP[t.name];
    const iconSrc = iconKey ? TRACK_ICONS[iconKey] : '';
    card.innerHTML = `
      <div class="track-card-text">
        <div class="track-card-num">${(i+1).toString().padStart(2,'0')} / ${TRACKS.length}</div>
        <div class="track-card-name">${t.name}</div>
        <div class="track-card-song">${t.song} ‚Äî ${t.artist}</div>
      </div>
      ${iconSrc ? `<img class="track-card-icon" src="${iconSrc}" alt="${t.name}">` : ''}
    `;
    card.onclick = () => loadTrack(i);
    grid.appendChild(card);
  });
}

function showTrackSelect() {
  dismissBreakScreen();
  stopTrack();
  document.getElementById('track-select').classList.remove('hidden');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LOAD TRACK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadTrack(idx) {
  dismissBreakScreen();
  document.getElementById('track-select').classList.add('hidden');
  currentTrackIdx = idx;
  currentMoveIdx  = -1;
  elapsed = 0;
  playing = false;
  clearInterval(timer);

  const track = TRACKS[idx];

  // Compute move timestamps ‚Äî offset by intro if calibrated
  moveTimestamps = [];
  let t = track.introOffset || 0;
  track.moves.forEach(m => {
    moveTimestamps.push(t);
    t += m.duration;
  });

  // Header
  document.getElementById('track-name').textContent = track.name.toUpperCase();
  document.getElementById('song-info').textContent = `${track.song} ‚Äî ${track.artist}`;
  document.getElementById('btn-play').textContent = 'PLAY';
  document.getElementById('btn-play').disabled = false;
  document.getElementById('btn-calib').disabled = false;
  document.getElementById('btn-calib').textContent = 'üéØ';
  document.getElementById('btn-calib').onclick = startCalibration;
  document.getElementById('btn-next-track').style.display = 
    idx >= TRACKS.length - 1 ? 'none' : '';
  document.getElementById('btn-prev-track').style.display =
    idx <= 0 ? 'none' : '';
  calibMode = false;
  document.body.classList.remove('calibrating', 'editing');
  document.getElementById('calib-bar').classList.remove('visible');

  // Meta strip
  const meta = document.getElementById('sub-bar-meta');
  meta.innerHTML = `
    <div class="meta-item">Weight <span>${track.weight}</span></div>
    <div class="meta-item">Start at <span>${track.startAt}</span></div>
  `;

  // Show/hide header columns for cooldown
  const headerRow = document.querySelector('.row-header');
  if (track.isCooldown) {
    headerRow.style.display = 'none';
  } else {
    headerRow.style.display = 'grid';
  }

  // Build rows
  const container = document.getElementById('rows-container');
  container.innerHTML = '';
  track.moves.forEach((m, i) => {
    const row = document.createElement('div');
    row.className = 'row' + (m.type === 'banner' ? ' banner' : '');
    row.id = `row-${i}`;

    if (m.type === 'banner') {
      row.innerHTML = `<div class="cell cell-banner">${m.move}</div>`;
    } else if (track.isCooldown) {
      row.style.gridTemplateColumns = '1fr';
      row.innerHTML = `<div class="cell cell-move">${m.move}${m.cue ? `<div class="cell-cue">${m.cue}</div>` : ''}</div>`;
    } else {
      row.innerHTML = `
        <div class="cell cell-timing">${m.timing || ''}</div>
        <div class="cell cell-move">${m.move}${m.cue ? `<div class="cell-cue">${m.cue}</div>` : ''}</div>
        <div class="cell cell-reps">${m.reps || ''}</div>
      `;
    }
    container.appendChild(row);
  });

  // Progress dots
  buildDots();
  updateDots();
  updateClock();
  updateProgressBar();
  scrollToMove(-1);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PROGRESS DOTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDots() {
  const dotsEl = document.getElementById('progress-dots');
  dotsEl.innerHTML = '';
  TRACKS.forEach((t, i) => {
    const d = document.createElement('div');
    d.className = 'dot';
    d.setAttribute('data-label', t.name);
    d.onclick = () => loadTrack(i);
    dotsEl.appendChild(d);
  });
}

function updateDots() {
  const dots = document.querySelectorAll('.dot');
  dots.forEach((d, i) => {
    d.className = 'dot';
    if (i < currentTrackIdx) d.classList.add('done');
    else if (i === currentTrackIdx) d.classList.add('active');
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PLAY / PAUSE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePlay() {
  if (playing) {
    pauseTrack();
  } else {
    if (currentMoveIdx === -1) {
      startCountdown();
    } else {
      playTrack();
    }
  }
}

function startCountdown(onComplete) {
  const overlay = document.getElementById('countdown-overlay');
  const numEl   = document.getElementById('countdown-num');
  overlay.classList.remove('hidden');
  let count = 10;
  numEl.textContent = count;

  const cd = setInterval(() => {
    count--;
    if (count <= 0) {
      clearInterval(cd);
      overlay.classList.add('hidden');
      if (onComplete) onComplete();
      else playTrack();
    } else {
      numEl.textContent = count;
    }
  }, 1000);
}

function playTrack() {
  playing = true;
  document.getElementById('btn-play').textContent = 'PAUSE';
  timer = setInterval(tick, 1000);
  requestWakeLock();
}

function pauseTrack() {
  playing = false;
  document.getElementById('btn-play').textContent = 'PLAY';
  clearInterval(timer);
  hideNextMoveCountdown();
}

function stopTrack() {
  pauseTrack();
  currentMoveIdx = -1;
  elapsed = 0;
}

function nextTrack() {
  if (currentTrackIdx < TRACKS.length - 1) {
    loadTrack(currentTrackIdx + 1);
  }
}

function prevTrack() {
  if (currentTrackIdx > 0) {
    loadTrack(currentTrackIdx - 1);
  }
}

function restartTrack() {
  stopTrack();
  loadTrack(currentTrackIdx);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TICK
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick() {
  elapsed++;
  const track = TRACKS[currentTrackIdx];

  // In calibration mode, just update the clock ‚Äî don't auto-advance rows
  if (calibMode) {
    updateClock();
    return;
  }

  // Find current move
  let newIdx = -1;
  for (let i = 0; i < moveTimestamps.length; i++) {
    if (elapsed >= moveTimestamps[i]) newIdx = i;
    else break;
  }

  if (newIdx !== currentMoveIdx) {
    currentMoveIdx = newIdx;
    scrollToMove(currentMoveIdx);
    hideNextMoveCountdown();
  }

  // Show countdown 3 seconds before next move
  updateNextMoveCountdown();

  updateClock();
  updateProgressBar();

  // Auto-advance to next track
  if (elapsed >= track.totalDuration) {
    pauseTrack();
    if (autoplayEnabled && currentTrackIdx < TRACKS.length - 1) {
      startBreakScreen(currentTrackIdx + 1);
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTOPLAY & BREAK SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let autoplayEnabled = false;
let breakTimer = null;
let breakSecondsLeft = 0;
let breakTotalSeconds = 0;

// Break durations: null means no break (flow straight in)

function toggleAutoplay() {
  autoplayEnabled = !autoplayEnabled;
  document.getElementById('btn-autoplay').classList.toggle('active', autoplayEnabled);
}

function startBreakScreen(nextIdx) {
  const nextTrackData = TRACKS[nextIdx];
  const currentId = TRACKS[currentTrackIdx].id;
  const breakDuration = BREAK_AFTER[currentId];

  if (!breakDuration) {
    // No break ‚Äî load next track immediately and autoplay
    loadTrack(nextIdx);
    startCountdown(() => { togglePlay(); });
    return;
  }

  breakTotalSeconds = breakDuration;
  breakSecondsLeft = breakDuration;

  document.getElementById('break-next-track').textContent = nextTrackData.name.toUpperCase();
  document.getElementById('break-timer').textContent = breakSecondsLeft;
  document.getElementById('break-bar').style.width = '100%';
  document.getElementById('break-screen').classList.remove('hidden');

  clearInterval(breakTimer);
  breakTimer = setInterval(() => {
    breakSecondsLeft--;
    document.getElementById('break-timer').textContent = breakSecondsLeft;
    const pct = (breakSecondsLeft / breakTotalSeconds) * 100;
    document.getElementById('break-bar').style.width = pct + '%';

    // With 10 seconds left, load track and start countdown overlay
    if (breakSecondsLeft === 10) {
      loadTrack(nextIdx);
      document.getElementById('break-screen').classList.add('hidden');
      clearInterval(breakTimer);
      startCountdown(() => { togglePlay(); });
    }
  }, 1000);
}

function dismissBreakScreen() {
  clearInterval(breakTimer);
  document.getElementById('break-screen').classList.add('hidden');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCROLL TO MOVE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scrollToMove(idx) {
  document.querySelectorAll('.row').forEach(r => {
    r.classList.remove('active', 'next');
  });

  const container = document.getElementById('scroll-container');

  if (idx >= 0) {
    const activeRow = document.getElementById(`row-${idx}`);
    if (activeRow) {
      activeRow.classList.add('active');

      // Mark next data row
      for (let j = idx + 1; j < TRACKS[currentTrackIdx].moves.length; j++) {
        const nextRow = document.getElementById(`row-${j}`);
        if (nextRow && !nextRow.classList.contains('banner')) {
          nextRow.classList.add('next');
          break;
        }
      }

      // Scroll active row to ~25% from top
      const containerH = container.clientHeight;
      const rowTop = activeRow.offsetTop;
      const targetScroll = rowTop - containerH * 0.25;
      container.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });
    }
  } else {
    container.scrollTo({ top: 0, behavior: 'instant' });
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UI UPDATES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  document.getElementById('clock').textContent = `${m}:${String(s).padStart(2,'0')}`;
}

function updateProgressBar() {
  const track = TRACKS[currentTrackIdx];
  let pct = 0;

  if (currentMoveIdx >= 0 && currentMoveIdx < moveTimestamps.length) {
    const moveStart = moveTimestamps[currentMoveIdx];
    const moveEnd = moveTimestamps[currentMoveIdx + 1] !== undefined
      ? moveTimestamps[currentMoveIdx + 1]
      : moveStart + track.moves[currentMoveIdx].duration;
    const moveDur = moveEnd - moveStart;
    if (moveDur > 0) {
      pct = Math.min(100, ((elapsed - moveStart) / moveDur) * 100);
    }
  }

  document.getElementById('song-progress-fill').style.width = pct + '%';
}

function updateNextUp() {
  const track = TRACKS[currentTrackIdx];
  const chip = document.getElementById('next-up');
  const nextText = document.getElementById('next-up-text');

  // Find next data row
  let next = null;
  for (let j = currentMoveIdx + 1; j < track.moves.length; j++) {
    if (track.moves[j].type !== 'banner') {
      next = track.moves[j];
      break;
    }
  }

  if (next) {
    chip.style.display = 'block';
    nextText.textContent = next.move;
  } else {
    chip.style.display = 'none';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MANUAL EDIT MODE
// Reveals a seconds input on every row so you
// can tweak durations without recalibrating
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CALIBRATION MODE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let calibMode = false;
let calibTaps = [];
let calibMoveIdx = 0;
let calibCountdownTimer = null;

function startCalibration() {
  // Clear any potentially stuck disabled state
  document.getElementById('btn-calib').disabled = false;

  // Stop everything cleanly first
  clearInterval(timer);
  clearInterval(calibCountdownTimer);
  pauseTrack();

  calibMode = true;
  calibTaps = [];
  calibMoveIdx = -1;  // -1 = waiting for first move start tap
  calibIntroOffset = 0;

  // ‚îÄ‚îÄ Wipe existing timestamps so the track doesn't auto-scroll ‚îÄ‚îÄ
  // Set all durations to a huge number so nothing fires during calibration
  const track = TRACKS[currentTrackIdx];
  moveTimestamps = track.moves.map(() => 999999);
  elapsed = 0;
  currentMoveIdx = -1;

  // Reset the display
  document.getElementById('scroll-container').scrollTo({ top: 0, behavior: 'instant' });
  document.querySelectorAll('.row').forEach(r => r.classList.remove('active', 'next'));
  updateClock();
  updateProgressBar();

  document.body.classList.add('calibrating');
  document.getElementById('calib-bar').classList.add('visible');
  document.getElementById('calib-save-btn').classList.remove('visible');
  document.getElementById('btn-play').disabled = true;
  document.getElementById('btn-calib').textContent = '‚úï Exit';
  document.getElementById('btn-calib').onclick = stopCalibration;

  // Reset/add calib stamp badges on rows
  document.querySelectorAll('.row').forEach(r => {
    let stamp = r.querySelector('.calib-stamp');
    if (!stamp) {
      stamp = document.createElement('div');
      stamp.className = 'calib-stamp';
      r.appendChild(stamp);
    }
    stamp.textContent = '‚Äî';
  });

  // Disable button, start 5 second countdown
  const nextBtn = document.getElementById('calib-next-btn');
  nextBtn.disabled = true;
  nextBtn.textContent = 'Starting in 5‚Ä¶';
  document.getElementById('calib-label').innerHTML =
    'üéØ Get Deezer ready ‚Äî <strong id="calib-move-name">starting in 5‚Ä¶</strong>';

  let count = 5;
  calibCountdownTimer = setInterval(() => {
    count--;
    if (count <= 0) {
      clearInterval(calibCountdownTimer);
      // Start the clock ‚Äî but tick() won't auto-advance because moveTimestamps are all 999999
      playing = true;
      timer = setInterval(tick, 1000);
      requestWakeLock();
      nextBtn.disabled = false;
      nextBtn.textContent = 'FIRST MOVE START ‚ñ∂';
      document.getElementById('calib-label').innerHTML =
        'üéØ Tap when the <strong id="calib-move-name">first move begins</strong>';
    } else {
      nextBtn.textContent = `Starting in ${count}‚Ä¶`;
      document.getElementById('calib-label').innerHTML =
        `üéØ Get Deezer ready ‚Äî <strong id="calib-move-name">starting in ${count}‚Ä¶</strong>`;
    }
  }, 1000);
}

function stopCalibration() {
  clearInterval(calibCountdownTimer);
  calibMode = false;
  pauseTrack();
  document.body.classList.remove('calibrating');
  document.getElementById('calib-bar').classList.remove('visible');
  document.getElementById('btn-play').disabled = false;
  document.getElementById('btn-calib').textContent = 'üéØ Calibrate';
  document.getElementById('btn-calib').onclick = startCalibration;
  // Restore real timestamps including intro offset
  const track = TRACKS[currentTrackIdx];
  moveTimestamps = [];
  let t = track.introOffset || 0;
  track.moves.forEach(m => { moveTimestamps.push(t); t += m.duration; });
  elapsed = 0;
  currentMoveIdx = -1;
  playing = false;
  document.getElementById('btn-play').textContent = 'PLAY';
  document.getElementById('scroll-container').scrollTo({ top: 0, behavior: 'instant' });
  document.querySelectorAll('.row').forEach(r => r.classList.remove('active', 'next'));
  updateClock();
  updateProgressBar();
}

let calibIntroOffset = 0; // elapsed time when first move started

function calibTap() {
  const track = TRACKS[currentTrackIdx];
  const tapTime = elapsed;
  const nextBtn = document.getElementById('calib-next-btn');

  // First tap = marks when the first move begins (end of intro)
  if (calibMoveIdx === -1) {
    calibIntroOffset = tapTime; // record intro length
    calibMoveIdx = 0;

    // Highlight first row
    const firstRow = document.getElementById('row-0');
    if (firstRow) firstRow.classList.add('active');

    nextBtn.textContent = 'NEXT MOVE ‚ñ∂';
    document.getElementById('calib-label').innerHTML =
      'üéØ Tap when each move ends ‚Äî <strong id="calib-move-name"></strong>';
    updateCalibLabel();
    return;
  }

  // Subsequent taps = marks end of current move
  // Store time relative to intro offset so move 0 starts at 0
  const moveTime = tapTime - calibIntroOffset;
  calibTaps.push(moveTime);

  // Stamp the row we just finished
  const rowEl = document.getElementById(`row-${calibMoveIdx}`);
  if (rowEl) {
    const stamp = rowEl.querySelector('.calib-stamp');
    const m = Math.floor(moveTime / 60);
    const s = moveTime % 60;
    if (stamp) stamp.textContent = `‚ñ∂ ${m}:${String(s).padStart(2,'0')}`;
    rowEl.classList.remove('active');
  }

  calibMoveIdx++;

  if (calibMoveIdx < track.moves.length) {
    // Highlight next row and scroll to it
    const nextRow = document.getElementById(`row-${calibMoveIdx}`);
    if (nextRow) {
      nextRow.classList.add('active');
      const container = document.getElementById('scroll-container');
      const containerH = container.clientHeight;
      const rowTop = nextRow.offsetTop;
      const targetScroll = rowTop - containerH * 0.25;
      container.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });
    }
    updateCalibLabel();
  } else {
    // All moves done
    pauseTrack();
    nextBtn.disabled = true;
    nextBtn.textContent = 'Done ‚úì';
    document.getElementById('calib-save-btn').classList.add('visible');
    document.getElementById('calib-label').innerHTML =
      '‚úÖ All moves marked ‚Äî <strong>tap Save when ready</strong>';
  }
}

function updateCalibLabel() {
  const track = TRACKS[currentTrackIdx];
  if (calibMoveIdx < track.moves.length) {
    const move = track.moves[calibMoveIdx];
    const label = move.type === 'banner'
      ? `[banner] ${move.move}`
      : `${move.timing || '‚Äî'} ¬∑ ${move.move}`;
    const nameEl = document.getElementById('calib-move-name');
    if (nameEl) nameEl.textContent = `${calibMoveIdx + 1}/${track.moves.length}: ${label}`;
  }
}

function finishCalibration() {
  const track = TRACKS[currentTrackIdx];

  // calibTaps[i] = seconds since first move started when move i ended
  // move 0 starts at 0, move i starts at calibTaps[i-1]
  const newDurations = track.moves.map((m, i) => {
    const start = i === 0 ? 0 : (calibTaps[i - 1] || 0);
    const end   = calibTaps[i] !== undefined ? calibTaps[i] : start + m.duration;
    return Math.max(1, end - start);
  });

  // Total duration includes the intro so playback timer aligns with song start
  const movesTotal = calibTaps.length > 0 ? calibTaps[calibTaps.length - 1] : track.totalDuration;
  const newTotal = calibIntroOffset + movesTotal;

  let lines = [];
  lines.push(`// ‚îÄ‚îÄ ${track.name.toUpperCase()} ‚Äî Calibrated timestamps ‚îÄ‚îÄ`);
  lines.push(`// totalDuration: ${newTotal}, introOffset: ${calibIntroOffset}`);
  lines.push('');
  track.moves.forEach((m, i) => {
    const oldDur = m.duration;
    const newDur = newDurations[i];
    const changed = newDur !== oldDur ? `  ‚óÄ was ${oldDur}` : '';
    const label = m.type === 'banner' ? `[banner] ${m.move}` : `${m.timing || '‚Äî'} ¬∑ ${m.move}`;
    lines.push(`{ duration: ${newDur} },  // ${label}${changed}`);
  });

  document.getElementById('calib-result-track').textContent = track.name;
  document.getElementById('calib-result-code').textContent = lines.join('\n');
  document.getElementById('calib-result').classList.add('visible');

  // Apply live ‚Äî store intro offset so moveTimestamps are computed correctly
  track.introOffset = calibIntroOffset;
  track.moves.forEach((m, i) => { m.duration = newDurations[i]; });
  track.totalDuration = newTotal;

  // Persist to localStorage
  saveCalibrations();
  buildTrackSelect();

  stopCalibration();
}

function copyCalibResult() {
  const text = document.getElementById('calib-result-code').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('#calib-result .btn-primary');
    btn.textContent = 'Copied ‚úì';
    setTimeout(() => btn.textContent = 'Copy to clipboard', 2000);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// WAKE LOCK (keeps iPad screen on)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let wakeLock = null;

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      document.getElementById('wake-indicator').classList.add('active');
      wakeLock.addEventListener('release', () => {
        document.getElementById('wake-indicator').classList.remove('active');
      });
    }
  } catch (e) {
    // Wake lock not available ‚Äî silent fail
  }
}

// Re-acquire wake lock when tab becomes visible again
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && playing) {
    requestWakeLock();
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAP ZONE ‚Äî tap anywhere on the scroll area to play/pause
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAP TO PLAY/PAUSE on scroll area
// Distinguishes a tap from a scroll so both work
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const container = document.getElementById('scroll-container');
  let touchStartY = 0;
  let touchStartTime = 0;

  container.addEventListener('touchstart', e => {
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
  }, { passive: true });

  container.addEventListener('touchend', e => {
    const dy = Math.abs(e.changedTouches[0].clientY - touchStartY);
    const dt = Date.now() - touchStartTime;
    if (dy < 10 && dt < 250 && !calibMode) {
      if (currentMoveIdx >= 0 || playing) togglePlay();
    }
  }, { passive: true });
})();

function handleTapZone() {} // kept for compatibility

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LONG PRESS TO JUMP TO MOVE
// Hold any row for 500ms to jump to that point
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  let pressTimer = null;
  let pressRow = null;

  function startPress(e) {
    if (calibMode) return;
    const row = e.target.closest('.row[id^="row-"]');
    if (!row) return;
    pressRow = row;
    row.classList.add('jump-ready');
    pressTimer = setTimeout(() => {
      const idx = parseInt(row.id.replace('row-', ''));
      if (!isNaN(idx) && moveTimestamps[idx] !== undefined) {
        elapsed = moveTimestamps[idx];
        currentMoveIdx = idx - 1; // tick() will advance to idx
        if (!playing) {
          playing = true;
          timer = setInterval(tick, 1000);
          requestWakeLock();
          document.getElementById('btn-play').textContent = 'PAUSE';
        }
        tick(); // immediate update
      }
      row.classList.remove('jump-ready');
      pressRow = null;
    }, 500);
  }

  function cancelPress() {
    if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
    if (pressRow) { pressRow.classList.remove('jump-ready'); pressRow = null; }
  }

  const container = document.getElementById('scroll-container');
  container.addEventListener('touchstart', startPress, { passive: true });
  container.addEventListener('touchend', cancelPress, { passive: true });
  container.addEventListener('touchmove', cancelPress, { passive: true });
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// KEYBOARD SHORTCUTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'ArrowRight' && currentTrackIdx < TRACKS.length - 1) loadTrack(currentTrackIdx + 1);
  if (e.code === 'ArrowLeft' && currentTrackIdx > 0) loadTrack(currentTrackIdx - 1);
  if (e.code === 'KeyR') restartTrack();
  if (e.code === 'Escape') showRoutineMenu();
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ROUTINE MENU
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showRoutineMenu() {
  dismissBreakScreen();
  stopTrack();
  document.getElementById('track-select').classList.add('hidden');
  document.getElementById('routine-menu').classList.remove('hidden');
}

function loadRoutineList() {
  const grid = document.getElementById('routine-grid');
  grid.innerHTML = '';
  const routines = window.ROUTINES || [];
  if (routines.length === 0) {
    grid.innerHTML = '<div style="color:var(--text-dim);font-family:\'Bebas Neue\',sans-serif;letter-spacing:2px;grid-column:1/-1;text-align:center;padding:40px;">No routines loaded.<br>Check routines/nu-metal.js is in the same folder.</div>';
    return;
  }
  routines.forEach((r, idx) => {
    const card = document.createElement('div');
    card.className = 'routine-card';
    const fontStyle = r.font ? `style="font-family:'${r.font}',cursive"` : '';
    card.innerHTML = `
      <div class="routine-card-name" ${fontStyle}>${r.name}</div>
      <div class="routine-card-meta">${r.tracks.length} tracks</div>
    `;
    card.onclick = () => loadRoutine(idx);
    grid.appendChild(card);
  });
}

function loadRoutine(idx) {
  const r = window.ROUTINES[idx];
  ROUTINE_NAME   = r.name;
  TRACKS         = r.tracks;
  TRACK_ICONS    = r.icons;
  TRACK_ICON_MAP = r.iconMap;
  BREAK_AFTER    = r.breakAfter;

  loadCalibrations();
  document.getElementById('routine-menu').classList.add('hidden');
  buildTrackSelect();

  // Apply routine-specific font to routine name (must be after buildTrackSelect)
  const nameEl = document.getElementById('routine-name');
  if (nameEl) {
    nameEl.style.fontFamily = r.font ? `'${r.font}', cursive` : "'Bebas Neue', sans-serif";
    nameEl.style.fontSize = '36px';
  }

  loadTrack(0);
  document.getElementById('track-select').classList.remove('hidden');
}

// Update home button to go to routine menu, not track select
document.querySelector('[onclick="showTrackSelect()"]').setAttribute('onclick', 'showRoutineMenu()');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// START
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener("load", () => {

  loadCalibrations();

  loadRoutineList();

  document.getElementById('routine-menu').classList.remove('hidden');

  document.getElementById('track-select').classList.add('hidden');

});
</script>
</body>
</html>
